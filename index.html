Asteroid-Game/index.html<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙ‚ÙˆØ± Ø§Ù„Ø¬Ùˆ Ø§Ù„Ù…ØµØ±ÙŠ ÙˆÙ…Ù‡Ù…Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±</title>
    <!-- ØªØ¶Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø© Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0d1117; 
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            padding: 1rem;
        }
        #gameCanvas {
            background-color: #0b1a38; 
            border: 5px solid #eab308; /* Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ Ù…ØµØ±ÙŠ */
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(234, 179, 8, 0.7);
            touch-action: none; 
            position: relative;
        }
        .control-panel {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid #ef4444; 
        }
        .styled-button {
            padding: 0.75rem 1.5rem;
            font-weight: 800;
            border-radius: 9999px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
        }
        .styled-button:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(17, 24, 39, 0.98);
            border: 4px solid #facc15; 
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            max-width: 90%;
            width: 350px;
        }
        .char-icon {
            font-size: 35px;
            line-height: 1;
            transition: transform 0.2s;
            background-color: #374151;
            border-radius: 8px;
            padding: 0.5rem;
            border: 2px solid transparent;
        }
        .char-icon.selected {
            border: 4px solid #facc15;
            background-color: #4b5563;
        }
        #sky-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: -1;
        }
        .star {
            position: absolute;
            background-color: #ffffff;
            border-radius: 50%;
            opacity: 0.8;
            animation: move-sky linear infinite;
        }
        @keyframes move-sky {
            from { transform: translateY(0); }
            to { transform: translateY(600px); } 
        }
        .boss-active #gameCanvas {
            box-shadow: 0 0 40px 10px rgba(255, 0, 0, 0.8), 0 0 30px rgba(234, 179, 8, 0.7);
        }
        /* ØªØµÙ…ÙŠÙ… Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±Ø² */
        #audioLoading {
            background-color: #2563eb;
            color: #ffffff;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.8);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body onload="initializeGame()">

    <div id="game-container" class="w-full max-w-xl">
        
        <header class="control-panel text-center mb-4 flex justify-between items-center">
            <div class="text-xl font-bold">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="scoreDisplay" class="text-yellow-400">0</span></div>
            <div class="text-xl font-bold">Ø§Ù„Ø­ÙŠØ§Ø©: <span id="healthDisplay" class="text-red-400">3</span></div>
        </header>

        <div class="relative mx-auto block">
            <div id="sky-background"></div>
            <canvas id="gameCanvas" width="400" height="600"></canvas>
            
            <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ -->
            <div id="audioLoading" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden">
                Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø§Ø¨ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©...
            </div>
        </div>

        <!-- Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø®ØµÙŠØ© -->
        <div id="startScreen" class="message-box w-11/12 max-w-sm">
            <h2 class="text-3xl font-black mb-4 text-cyan-400">ØµÙ‚ÙˆØ± Ø§Ù„Ø¬Ùˆ Ø§Ù„Ù…ØµØ±ÙŠ ğŸ‡ªğŸ‡¬</h2>
            <h3 class="text-xl font-extrabold mb-4 text-yellow-400">Ù…Ù‡Ù…Ø© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h3>
            
            <!-- ØªØ­ÙŠØ© Ù…Ø­Ù…Ø¯ ØµØ¨Ø±ÙŠ -->
            <p class="text-sm text-gray-500 mb-6 border-t border-gray-700 pt-3">
                Ù…Ø¹ ØªØ­ÙŠØ§ØªÙŠ: Ù…Ø­Ù…Ø¯ ØµØ¨Ø±ÙŠ Ø§Ù„Ø´Ø±Ù‚Ø§ÙˆÙŠ.
            </p>
            
            <p class="mb-6 text-gray-300">Ø§Ø®ØªØ± Ø·Ø§Ø¦Ø±ØªÙƒ/Ù‚Ø§Ø¦Ø¯Ùƒ Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:</p>
            
            <div id="char-selection" class="flex justify-around mb-6">
                <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø³ÙŠØ³ÙŠ -->
                <button data-char="Ø§Ù„Ø³ÙŠØ³ÙŠ" data-emoji="â­" class="char-icon hover:scale-110 transition p-2 rounded-lg">â­</button>
                <button data-char="Omar" data-emoji="ğŸª–" class="char-icon hover:scale-110 transition p-2 rounded-lg">ğŸª–</button>
                <button data-char="Zizo" data-emoji="âœˆï¸" class="char-icon hover:scale-110 transition p-2 rounded-lg">âœˆï¸</button>
                <button data-char="Souad" data-emoji="ğŸ›¸" class="char-icon hover:scale-110 transition p-2 rounded-lg">ğŸ›¸</button>
                <button data-char="Huda" data-emoji="ğŸš" class="char-icon hover:scale-110 transition p-2 rounded-lg">ğŸš</button>
            </div>
            
            <button id="startButton" class="styled-button bg-green-500 hover:bg-green-600 text-white hidden" disabled>
                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø·Ù„Ø¹Ø© Ø§Ù„Ø¬ÙˆÙŠØ©!
            </button>
            <p id="selectionMessage" class="text-sm text-yellow-500 mt-2">Ø§Ø®ØªØ± Ù‚Ø§Ø¦Ø¯Ùƒ/Ø·Ø§Ø¦Ø±ØªÙƒ.</p>
        </div>

        <!-- Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="gameOverScreen" class="message-box w-11/12 max-w-sm hidden">
            <h2 class="text-4xl font-black mb-4 text-red-500">ØªÙ… ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø·Ø§Ø¦Ø±Ø©! ğŸ’¥</h2>
            <p class="text-xl mb-4 text-gray-200">Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span id="finalScore" class="text-yellow-400 font-extrabold">0</span></p>
            
            <p class="text-md mb-6 text-yellow-200 border-b border-yellow-700 pb-3">
                âš ï¸ **ØªØ°ÙƒÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ø¯:** Ø§Ù„ØµÙ„Ø§Ø©ØŒ Ø¨Ø± Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†ØŒ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†ØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª Ù‡ÙŠ Ù…Ù‡Ø§Ù…Ùƒ Ø§Ù„Ø£Ù‡Ù…!
            </p>
            
            <button id="restartButton" class="styled-button bg-blue-500 hover:bg-blue-600 text-white mt-4">
                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·ÙŠØ±Ø§Ù†
            </button>
        </div>
        
        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ø¤Ù‚ØªØ© -->
        <div id="powerupMessage" class="fixed top-4 left-1/2 -translate-x-1/2 bg-yellow-600 text-white p-3 rounded-lg shadow-xl font-bold hidden opacity-0 transition-opacity duration-300">
            ØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ¹Ø²ÙŠØ²!
        </div>
    </div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¹Ø¨Ø©
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        const GAME_SPEED = 2.5; 
        const BASE_PLAYER_SIZE = 35; 
        let score = 0;
        let health = 3; 
        let isPlaying = false;
        let playerChar = null; 
        let currentSectorIndex = 0; 
        let isBossActive = false; 
        const SCORE_TO_NEXT_STAGE = 600; 
        let stageTransitionTimer = 0; 

        // Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (Ø§Ù„Ù…Ø±Ø§Ø­Ù„)
        const LOCATIONS = [
            'Ø§Ù„Ù…Ù‡Ù…Ø© 1: Ø³Ù…Ø§Ø¡ Ù…ØµØ± - Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 2: ØªØ­Ø±ÙŠØ± Ø§Ù„Ø³ÙˆØ¯Ø§Ù† ğŸ‡¸ğŸ‡©',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 3: ØªØ­Ø±ÙŠØ± Ù„ÙŠØ¨ÙŠØ§ ğŸ‡±ğŸ‡¾',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 4: ØªØ­Ø±ÙŠØ± ØªÙˆÙ†Ø³ ğŸ‡¹ğŸ‡³',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 5: ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± ğŸ‡©ğŸ‡¿',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 6: ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…ØºØ±Ø¨ ğŸ‡²ğŸ‡¦',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 7: ØªØ­Ø±ÙŠØ± Ø§Ù„ÙŠÙ…Ù† ğŸ‡¾ğŸ‡ª',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 8: ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø§Ù‚ ğŸ‡®ğŸ‡¶',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 9: ØªØ­Ø±ÙŠØ± Ø³ÙˆØ±ÙŠØ§ ğŸ‡¸ğŸ‡¾',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 10: ØªØ­Ø±ÙŠØ± ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 11: ØªØ­Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¯Ù† ğŸ‡¯ğŸ‡´',
            'Ø§Ù„Ù…Ù‡Ù…Ø© 12: ØªØ­Ø±ÙŠØ± Ù„Ø¨Ù†Ø§Ù† ğŸ‡±ğŸ‡§',
        ];
        
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²Ø¹ÙŠÙ… Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ 
        const BOSS_DEFINITION = { 
            emoji: 'ğŸ›°ï¸', 
            score: 500, 
            baseHealth: 5, 
            size: 70, 
            speed: 0.2 
        };
        
        // Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const scoreDisplay = document.getElementById('scoreDisplay');
        const healthDisplay = document.getElementById('healthDisplay');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton');
        const charSelection = document.getElementById('char-selection');
        const selectionMessage = document.getElementById('selectionMessage');
        const powerupMessage = document.getElementById('powerupMessage');
        const audioLoadingIndicator = document.getElementById('audioLoading');

        // ÙƒØ§Ø¦Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨
        let player = {
            x: canvas.width / 2,
            y: canvas.height - 50,
            width: BASE_PLAYER_SIZE,
            height: BASE_PLAYER_SIZE,
            emoji: 'ğŸª–',
            shootingCooldown: 0,
            maxCooldown: 5, 
            isInvincible: false,
            invincibleTimer: 0
        };

        let bullets = [];
        let enemies = [];
        let powerups = [];

        // ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ (Ø§Ù„Ù…Ø®Ø§Ø·Ø±)
        const enemyDefinitions = [
            { emoji: 'ğŸ›©ï¸', score: 10, health: 1, color: '#ef4444' }, 
            { emoji: 'ğŸš', score: 20, health: 2, color: '#a855f7' }, 
            { emoji: 'ğŸ“¡', score: 50, health: 3, color: '#facc15' }  
        ];
        
        // ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„ØªØ¹Ø²ÙŠØ²Ø§Øª (Ø§Ù„Ù‚ÙŠÙ… ÙˆØ§Ù„Ù†ØµØ§Ø¦Ø­)
        const powerupDefinitions = [
            { emoji: 'ğŸ•Œ', effect: 'invincibility', color: '#10b981', message: 'ØªØ¹Ø²ÙŠØ² Ø§Ù„ØµÙ„Ø§Ø© (Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡)' }, 
            { emoji: 'ğŸ“–', effect: 'extraLife', color: '#f59e0b', message: 'Ù†ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† (Ø­ÙŠØ§Ø© Ø¥Ø¶Ø§ÙÙŠØ©)' },
            { emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', effect: 'clearScreen', color: '#3b82f6', message: 'Ø¨Ø± Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ† (Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† Ø§Ù„Ù…Ø®Ø§Ø·Ø±)' }, 
            { emoji: 'â±ï¸', effect: 'rapidFire', color: '#06b6d4', message: 'Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„ÙˆÙ‚Øª (Ù†Ø§Ø± ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ø³Ø±Ø¹Ø© Ù…Ø¤Ù‚ØªØ§Ù‹)' },
            { emoji: 'ğŸ', effect: 'health', color: '#ef4444', message: 'Ø§Ù„ØºØ°Ø§Ø¡ Ø§Ù„ØµØ­ÙŠ (Ø§Ø³ØªØ¹Ø§Ø¯Ø© ØµØ­Ø©)' },      
            { emoji: 'ğŸ˜´', effect: 'slowMotion', color: '#8b5cf6', message: 'Ø§Ù„Ù†ÙˆÙ… Ø§Ù„ÙƒØ§ÙÙŠ (ØªØ¨Ø·Ø¦Ø© Ø§Ù„Ø²Ù…Ù†)' },         
            { emoji: 'ğŸ§¹', effect: 'scoreMultiplier', color: '#f97316', message: 'Ø§Ù„ØªÙ†Ø¸ÙŠÙ… (Ù…Ø¶Ø§Ø¹Ù Ù†Ù‚Ø§Ø·)' },      
            { emoji: 'ğŸ«‚', effect: 'fireRate', color: '#eab308', message: 'Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© (Ø²ÙŠØ§Ø¯Ø© Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†ÙŠØ±Ø§Ù†)' },        
        ];


        // ------------------------------------------
        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ù€ TTS API
        // ------------------------------------------

        // ØªÙ… ØªÙ‡ÙŠØ¦Ø© AudioContext Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø¯Ø§Ù„Ø© pcmToWav
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        /**
         * ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Base64 Ø¥Ù„Ù‰ ArrayBuffer.
         * @param {string} base64 - Ø³Ù„Ø³Ù„Ø© Base64.
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙƒØªØ§Ø¨Ø© Ø³Ù„Ø§Ø³Ù„ ÙÙŠ DataView
         */
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        /**
         * ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª PCM Ø®Ø§Ù… Ø¥Ù„Ù‰ Ù…Ù„Ù WAV Blob.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
            let offset = 0;

            // RIFF chunk descriptor
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + pcm16.length * bytesPerSample, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;
            
            // FMT chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4; 
            view.setUint16(offset, 1, true); offset += 2; 
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * numChannels * bytesPerSample, true); offset += 4; 
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2; 
            view.setUint16(offset, 8 * bytesPerSample, true); offset += 2; 
            
            // DATA chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, pcm16.length * bytesPerSample, true); offset += 4;

            for (let i = 0; i < pcm16.length; i++, offset += bytesPerSample) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        /**
         * ØªÙˆÙ„ÙŠØ¯ ÙˆØªØ´ØºÙŠÙ„ Ø®Ø·Ø§Ø¨ ØªØ­ÙÙŠØ²ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini TTS API.
         * @param {string} text - Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ØµÙˆØª.
         * @param {string} voiceName - Ø§Ø³Ù… Ø§Ù„ØµÙˆØª (Ù…Ø«Ù„ Kore, Puck).
         * @param {string} languageCode - ÙƒÙˆØ¯ Ø§Ù„Ù„ØºØ© (Ù…Ø«Ù„ ar-EG).
         */
        async function generateAndPlayTTS(text, voiceName = "Kore", languageCode = "ar-EG") {
            audioLoadingIndicator.classList.remove('hidden');
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© AudioContext
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        },
                        languageCode: languageCode
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let audioUrl = null;
            let retries = 0;
            const maxRetries = 3;
            let delay = 1000; 

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { 
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const rateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 16000; 

                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        audioUrl = URL.createObjectURL(wavBlob);
                        
                        const audio = new Audio(audioUrl);
                        // Ù†Ø³ØªØ®Ø¯Ù… audio.play() Ø¯Ø§Ø®Ù„ try/catch Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­Ø¸Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                        await audio.play().catch(e => {
                            console.error("Error playing audio (Auto-Play Blocked):", e);
                            showPowerupMessage("âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§!");
                        });
                        break; 
                    } else {
                        throw new Error("Invalid audio response structure or missing data.");
                    }
                } catch (error) {
                    console.error("Failed to generate or play TTS:", error);
                    retries = maxRetries; 
                }
            }
            audioLoadingIndicator.classList.add('hidden');
        }


        // ------------------------------------------
        // 1. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„ØªÙ‚Ø¯Ù…
        // ------------------------------------------

        function initializeGame() {
            setupInputHandlers();
            setupCharacterSelection();
            createSkyBackground(); 
            restartGameVariables();
        }

        function setupCharacterSelection() {
            Array.from(charSelection.children).forEach(button => {
                button.addEventListener('click', (e) => {
                    Array.from(charSelection.children).forEach(b => b.classList.remove('selected'));
                    
                    const charName = e.currentTarget.dataset.char;
                    const charEmoji = e.currentTarget.dataset.emoji;
                    playerChar = charName; 
                    player.emoji = charEmoji;
                    e.currentTarget.classList.add('selected');
                    
                    selectionMessage.textContent = `Ù„Ù‚Ø¯ Ø§Ø®ØªØ±Øª Ø§Ù„Ù‚Ø§Ø¦Ø¯: ${charName} (${charEmoji})`;
                    startButton.classList.remove('hidden');
                    startButton.disabled = false;
                });
            });

            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', startGame);
        }
        
        // ÙˆØ¸ÙŠÙØ© Ù„ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù†Ù‚Ø±Ø© Ø¨Ø³ÙŠØ· Ù„ØªÙØ¹ÙŠÙ„ AudioContext
        function activateAudioContext() {
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log("AudioContext resumed on user interaction.");
                }).catch(e => console.error("Could not resume AudioContext:", e));
            }
        }
        
        // Ø±Ø¨Ø· ØªÙØ¹ÙŠÙ„ AudioContext Ø¨Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
        document.body.addEventListener('click', activateAudioContext, { once: true });
        document.body.addEventListener('touchstart', activateAudioContext, { once: true });


        async function startGame() {
            if (!playerChar) return; 
            
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            isPlaying = true;
            restartGameVariables();
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø²Ø§ÙŠØ§ Ø§Ù„Ø®Ø§ØµØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø§Ø¦Ø¯
